#!/usr/bin/env ruby
# frozen_string_literal: true

require 'thor'
require 'yaml'
require 'fileutils'

# Add lib to load path
$LOAD_PATH.unshift(File.expand_path('../lib', __dir__))

require 'database'
require 'strava_api'
require 'sync'
require 'location_matcher'
require 'stats_calculator'
require 'html_generator'
require 'strava_stats/logging'
require 'strava_stats/component_factory'
require 'strava_stats/application'

module StravaStats
  class CLI < Thor
    include Logging

    class_option :config, type: :string, default: 'config.yml', desc: 'Path to config file'

    desc 'auth', 'Authorize with Strava (required on first run)'
    def auth
      setup_components
      @api.authorize!
      logger.info "\nYou can now run 'strava_stats sync' to download your activities."
    end

    desc 'sync', 'Sync activities from Strava'
    option :full, type: :boolean, default: false, desc: 'Force full sync (ignore last sync time)'
    def sync
      setup_components
      ensure_authenticated!

      @syncer.sync_activities(full: options[:full])

      # Match activities to resorts and peaks
      @location_matcher.seed_resorts_if_empty
      @location_matcher.seed_peaks_if_empty
      @location_matcher.match_all_activities
    end

    desc 'fetch_details', 'Fetch detailed data (calories, etc.) for activities missing it'
    def fetch_details
      setup_components
      ensure_authenticated!

      @syncer.fetch_missing_details
    end

    desc 'refresh ACTIVITY_IDS', 'Refresh specific activities from Strava (re-fetch latest data)'
    long_desc <<-LONGDESC
      Re-fetches activity data from Strava for the specified activity IDs.
      Use this when you've edited activities on Strava and want to update your local database.

      Examples:
        strava_stats refresh 4915043957
        strava_stats refresh 4915043957 4915043958 4915043959

      You can find activity IDs in the Strava URL: https://www.strava.com/activities/4915043957
    LONGDESC
    def refresh(*activity_ids)
      if activity_ids.empty?
        logger.info "Usage: strava_stats refresh ACTIVITY_ID [ACTIVITY_ID ...]"
        logger.info "\nExample: strava_stats refresh 4915043957"
        logger.info "\nYou can find activity IDs in Strava URLs:"
        logger.info "  https://www.strava.com/activities/4915043957"
        exit 1
      end

      setup_components
      ensure_authenticated!

      ids = activity_ids.map(&:to_i)
      @syncer.refresh_activities(ids)

      # Re-match resorts and peaks for refreshed activities
      @location_matcher.match_all_activities
    end

    desc 'generate', 'Generate HTML stats page'
    def generate
      setup_components

      output_path = @app.generate_html(verbose: true)
      if output_path
        logger.info "\nOpen in browser: file://#{File.expand_path(output_path)}"
      else
        exit 1
      end
    end

    desc 'status', 'Show sync status'
    def status
      setup_components

      status = @syncer.sync_status
      logger.info "\n=== Sync Status ==="
      logger.info "Last sync: #{status[:last_sync] ? status[:last_sync].strftime('%Y-%m-%d %H:%M:%S') : 'Never'}"
      logger.info "Total activities: #{status[:total_activities]}"
      logger.info "Activities missing details: #{status[:without_details]}" if status[:without_details].to_i > 0
      logger.info "Newest activity: #{status[:newest_activity] ? status[:newest_activity].strftime('%Y-%m-%d') : 'N/A'}"

      tokens = @auth.get_tokens
      if tokens
        logger.info "\nAuthenticated as: #{tokens.dig(:athlete, 'firstname')} #{tokens.dig(:athlete, 'lastname')}"
      else
        logger.info "\nNot authenticated. Run 'strava_stats auth' first."
      end
    end

    desc 'resorts', 'List all resorts in database'
    option :add, type: :string, desc: 'Add a resort (format: "Name,Country,Region,Lat,Lng,Radius")'
    def resorts
      setup_components

      if options[:add]
        add_resort(options[:add])
        return
      end

      all_resorts = @resorts.all
      logger.info "\n=== Resorts Database (#{all_resorts.count} resorts) ==="

      by_country = all_resorts.group_by { |r| r['country'] }
      by_country.sort.each do |country, country_resorts|
        logger.info "\n#{country}:"
        country_resorts.sort_by { |r| r['name'] }.each do |r|
          type = r['resort_type'] == 'backcountry' ? ' [backcountry]' : ''
          logger.info "  #{r['name']} (#{r['region']})#{type}"
        end
      end
    end

    desc 'peaks', 'List all peaks in database'
    option :add, type: :string, desc: 'Add a peak (format: "Name,Country,Region,Lat,Lng,Elevation,Radius")'
    def peaks
      setup_components

      if options[:add]
        add_peak(options[:add])
        return
      end

      all_peaks = @peaks.all
      logger.info "\n=== Peaks Database (#{all_peaks.count} peaks) ==="

      by_country = all_peaks.group_by { |p| p['country'] }
      by_country.sort.each do |country, country_peaks|
        logger.info "\n#{country}:"
        country_peaks.sort_by { |p| p['name'] }.each do |p|
          elevation = p['elevation_m'] ? " (#{p['elevation_m']}m)" : ''
          logger.info "  #{p['name']}#{elevation} - #{p['region']}"
        end
      end
    end

    desc 'ignore ACTIVITY_IDS', 'Ignore activities (exclude from stats)'
    long_desc <<-LONGDESC
      Mark activities as ignored so they are excluded from statistics calculations.
      The activities remain in the database but won't appear in any stats or charts.

      Examples:
        strava_stats ignore 4915043957
        strava_stats ignore 4915043957 4915043958

      Use 'strava_stats ignored' to list all ignored activities.
      Use 'strava_stats unignore ID' to restore an activity.
    LONGDESC
    def ignore(*activity_ids)
      if activity_ids.empty?
        logger.info "Usage: strava_stats ignore ACTIVITY_ID [ACTIVITY_ID ...]"
        exit 1
      end

      setup_components

      activity_ids.each do |id|
        activity = @activities.find(id.to_i)
        if activity
          @activities.ignore(id.to_i)
          logger.info "Ignored: #{activity['name']} (#{activity['sport_type']}, #{activity['start_date_local']&.split('T')&.first})"
        else
          logger.warn "Activity not found: #{id}"
        end
      end

      logger.info "\nRun 'strava_stats generate' to update the HTML with the changes."
    end

    desc 'unignore ACTIVITY_IDS', 'Restore ignored activities to stats'
    def unignore(*activity_ids)
      if activity_ids.empty?
        logger.info "Usage: strava_stats unignore ACTIVITY_ID [ACTIVITY_ID ...]"
        exit 1
      end

      setup_components

      activity_ids.each do |id|
        activity = @activities.find(id.to_i)
        if activity
          @activities.unignore(id.to_i)
          logger.info "Restored: #{activity['name']} (#{activity['sport_type']})"
        else
          logger.warn "Activity not found: #{id}"
        end
      end

      logger.info "\nRun 'strava_stats generate' to update the HTML with the changes."
    end

    desc 'ignored', 'List all ignored activities'
    def ignored
      setup_components

      ignored_activities = @activities.ignored
      if ignored_activities.empty?
        logger.info "No ignored activities."
        return
      end

      logger.info "\n=== Ignored Activities (#{ignored_activities.count}) ==="
      ignored_activities.each do |a|
        date = a['start_date_local']&.split('T')&.first || 'unknown'
        logger.info "  #{a['id']}: #{a['name']} (#{a['sport_type']}, #{date})"
      end

      logger.info "\nUse 'strava_stats unignore ID' to restore an activity."
    end

    desc 'export', 'Export activities to CSV file'
    option :output, type: :string, default: 'activities.csv', desc: 'Output file path'
    option :include_ignored, type: :boolean, default: false, desc: 'Include ignored activities'
    def export
      setup_components

      require 'csv'

      activities = @activities.all(include_ignored: options[:include_ignored])
      output_file = options[:output]

      CSV.open(output_file, 'w') do |csv|
        # Header row
        csv << [
          'ID', 'Name', 'Sport', 'Date', 'Time',
          'Duration (min)', 'Distance (mi)', 'Elevation (ft)',
          'Calories', 'Avg Speed (mph)', 'Max Speed (mph)',
          'Avg HR', 'Max HR', 'City', 'State', 'Country',
          'Strava URL'
        ]

        # Data rows
        activities.each do |a|
          date_parts = a['start_date_local']&.split('T') || ['', '']
          duration_min = ((a['moving_time'] || 0) / 60.0).round(1)
          distance_mi = ((a['distance'] || 0) * 0.000621371).round(2)
          elevation_ft = ((a['total_elevation_gain'] || 0) * 3.28084).round(0)
          avg_speed = ((a['average_speed'] || 0) * 2.23694).round(1)
          max_speed = ((a['max_speed'] || 0) * 2.23694).round(1)

          csv << [
            a['id'],
            a['name'],
            a['sport_type'],
            date_parts[0],
            date_parts[1]&.gsub('Z', ''),
            duration_min,
            distance_mi,
            elevation_ft,
            (a['calories'] || 0).round(0),
            avg_speed,
            max_speed,
            a['average_heartrate']&.round(0),
            a['max_heartrate']&.round(0),
            a['location_city'],
            a['location_state'],
            a['location_country'],
            "https://www.strava.com/activities/#{a['id']}"
          ]
        end
      end

      logger.info "Exported #{activities.count} activities to #{output_file}"
    end

    desc 'run', 'Sync and generate stats (default command)'
    def run_all
      setup_components
      ensure_authenticated!

      # Sync will auto-generate HTML at completion and during rate limit pauses
      invoke :sync
    end

    default_task :run_all

    private

    def setup_components
      load_config

      # Use ComponentFactory to create all components
      @factory = ComponentFactory.new(@config)
      @app = Application.new(@factory)

      # Expose components for direct access where needed
      @api = @factory.api
      @location_matcher = @factory.location_matcher
      @stats_calculator = @factory.stats_calculator
      @html_generator = @factory.html_generator

      # Repositories
      @activities = @factory.activities
      @resorts = @factory.resorts
      @peaks = @factory.peaks
      @auth = @factory.auth

      # Create syncer with progress callback to regenerate HTML
      @syncer = @app.syncer_with_progress
    end

    def load_config
      config_path = options[:config]

      unless File.exist?(config_path)
        logger.error "Config file not found: #{config_path}"
        logger.info "\nCreate a config.yml file with your Strava API credentials:"
        logger.info "  cp config.yml.example config.yml"
        logger.info "  # Edit config.yml with your credentials from https://www.strava.com/settings/api"
        exit 1
      end

      @config = YAML.load_file(config_path)

      missing = []
      missing << 'strava.client_id' unless @config.dig('strava', 'client_id')
      missing << 'strava.client_secret' unless @config.dig('strava', 'client_secret')

      return if missing.empty?

      logger.error "Missing required config values: #{missing.join(', ')}"
      logger.info "Edit #{config_path} and add your Strava API credentials."
      exit 1
    end

    def ensure_authenticated!
      return if @api.authenticated?

      logger.warn 'Not authenticated with Strava.'
      logger.info "Run 'strava_stats auth' first to authorize."
      exit 1
    end

    def add_resort(resort_string)
      parts = resort_string.split(',').map(&:strip)

      if parts.length < 5
        logger.error 'Invalid format. Use: "Name,Country,Region,Latitude,Longitude[,RadiusKm][,Type]"'
        logger.info 'Example: "My Resort,USA,Colorado,39.5,-106.0,5.0,resort"'
        exit 1
      end

      resort = {
        name: parts[0],
        country: parts[1],
        region: parts[2],
        latitude: parts[3].to_f,
        longitude: parts[4].to_f,
        radius_km: parts[5]&.to_f || 5.0,
        resort_type: parts[6] || 'resort'
      }

      @resorts.insert(resort)
      logger.info "Added resort: #{resort[:name]}"

      # Re-match activities
      @location_matcher.match_all_activities
    end

    def add_peak(peak_string)
      parts = peak_string.split(',').map(&:strip)

      if parts.length < 5
        logger.error 'Invalid format. Use: "Name,Country,Region,Latitude,Longitude[,ElevationM][,RadiusKm]"'
        logger.info 'Example: "Mount Example,USA,Colorado,39.5,-106.0,4000,2.0"'
        exit 1
      end

      peak = {
        name: parts[0],
        country: parts[1],
        region: parts[2],
        latitude: parts[3].to_f,
        longitude: parts[4].to_f,
        elevation_m: parts[5]&.to_i,
        radius_km: parts[6]&.to_f || 2.0
      }

      @peaks.insert(peak)
      logger.info "Added peak: #{peak[:name]}"

      # Re-match activities
      @location_matcher.match_all_activities
    end
  end
end

StravaStats::CLI.start(ARGV)
